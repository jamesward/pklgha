amends "GitHubAction.pkl"

on {
  push {
    tags {
      "*"
    }
  }
}

// todo: refactor with GitHubActionJava
jobs {
  ["build-and-upload"] = new {
    `runs-on` = "ubuntu-24.04"

    permissions {
      contents = "write"
    }

    steps {
      new {
        name = "checkout"
        uses = "actions/checkout@v4"
      }
      new {
        uses = "actions/setup-java@v4"
        with {
          ["distribution"] = "temurin"
          ["java-version"] = "17"
          ["cache"] = "gradle"
        }
      }
      new {
        uses = "gradle/actions/setup-gradle@v3"
      }
      new {
        name = "build"
        env {
          ["VERSION"] = "${{ github.ref_name }}"
        }
        run = "./gradlew makePackages"
      }
      new {
        name = "release"
        uses = "softprops/action-gh-release@v2"
        with {
          ["files"] = "build/generated/pkl/packages/*"
        }
      }
      new {
        name = "create docs"
        env {
          ["VERSION"] = "${{ github.ref_name }}"
        }
        run = "./gradlew pkldoc"
      }
      new {
        name = "setup pages"
        uses = "actions/configure-pages@v4"
      }
      new {
        name = "upload artifact"
        uses = "actions/upload-pages-artifact@v3"
        with {
          ["path"] = "build/pkldoc/pkldoc"
        }
      }
    }
  }
  ["deploy-pages"] = new {
    `runs-on` = "ubuntu-24.04"
    needs = "build-and-upload"
    permissions {
      pages = "write"
      `id-token` = "write"
    }
    environment {
      name = "github-pages"
      url = "${{ steps.deployment.outputs.page_url }}"
    }
    steps {
      new {
        name = "deploy pages"
        id = "deployment"
        uses = "actions/deploy-pages@v4"
      }
    }
  }
}
