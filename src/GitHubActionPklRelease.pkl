module pklgha.GitHubActionPklRelease

extends "GitHubAction.pkl"

import "GitHubActionJava.pkl"

on {
  push {
    tags {
      "*"
    }
  }
}

jobs {
  ["build-and-upload"] = new {
    `runs-on` = "ubuntu-24.04"

    permissions {
      contents = "write"
    }

    steps {
      ...GitHubActionJava.gradleSteps("makePackages -Pversion=${{ github.ref_name }}", null)

      new {
        name = "release"
        uses = "softprops/action-gh-release@v2"
        with {
          ["files"] = "build/generated/pkl/packages/*"
        }
      }
    }
  }

  ["pkldoc"] = new {
    `runs-on` = "ubuntu-24.04"
    needs = "build-and-upload"
    steps {
      ...GitHubActionJava.gradleSteps("pkldoc -Pversion=${{ github.ref_name }}", null)

      new {
        name = "setup pages"
        uses = "actions/configure-pages@v4"
      }
      new {
        name = "upload artifact"
        uses = "actions/upload-pages-artifact@v3"
        with {
          ["path"] = "build/pkldoc/pkldoc"
        }
      }
    }
  }

  ["deploy-pages"] = new {
    `runs-on` = "ubuntu-24.04"
    needs = "pkldoc"
    permissions {
      pages = "write"
      `id-token` = "write"
    }
    environment {
      name = "github-pages"
      url = "${{ steps.deployment.outputs.page_url }}"
    }
    steps {
      new {
        name = "deploy pages"
        id = "deployment"
        uses = "actions/deploy-pages@v4"
      }
    }
  }
}
